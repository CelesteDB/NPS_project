---
title: "NPS Project Cox Model"
output: html_document
date: "2023-11-30"
---

```{r}
# per lettura dataset se prendi file da github
library(readxl)
data <- read_excel("../Dataset/JoinDatasets.xlsx", col_names = TRUE)
```

Libraries:
```{r,'error=FALSE', 'warning=FALSE'}
library(readxl)
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
```

Summary:
```{r}
summary(data)
```
Remove Technology Development satellite:
```{r}
data <- data[-which(data$Purpose == "Technology Development"),]
```


Rendi colonne factor:
```{r}
data$Country <- factor(data$Country, ordered = F)
print('Country')
table(data$Country)

data$Continent <- factor(data$Continent, ordered = F)
print('Continent')
table(data$Continent)

data$Users <- factor(data$Users, ordered = F)
print('Users')
table(data$Users)

data$Purpose <- factor(data$Purpose, ordered = F)
print('Purpose')
table(data$Purpose)

data$Orbit <- factor(data$Orbit, ordered = F)
print('Class of Orbit')
table(data$Orbit)

data$Status <- factor(data$Status, ordered = F)
print('Status')
table(data$Status)
```

Mischia righe
```{r}
data <- data[sample(nrow(data)), ]
```


Exploration of numerical variables:
```{r}
num <- c("Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period", "Mass")
data_num <- data[,num]

cor(data_num)
# Apogee - Period 0.96672436  
# Perigee - Inclination -0.88628415   
# Perigee - Period 0.8327784  
# Period - Inclination -0.73233046  
# Apogee - Perigee 0.67998408  
# Apogee - Eccentricity 0.67998408  
# Apogee - Inclination -0.60232423  
#Insomma, apogeo, periodo, perigeo, inclinazione, eccentricitÃ 

#tieni solo periodo

pairs(data_num)
```

Longitude of GEO
Perigee
Apogee
Eccentricity
Inclination
Period
Mass

Mass: include it
```{r}
plot(data$Mass, data$`Effective Lifetime`, xlab='Mass')
hist(data$Mass, xlab='Mass', main='Histogram of Mass', prob = TRUE)

summary(data$Mass)
```
Period:
```{r}
plot(data$Period, data$`Effective Lifetime`, xlab='Period')
hist(data$Period, xlab='Period', main='Histogram of Period', prob = TRUE)

summary(data$Period)
```
Inclination: 
```{r}
plot(data$Inclination, data$`Effective Lifetime`, xlab='Inclination')
hist(data$Inclination, xlab='Inclination', main='Histogram of Inclination', prob = TRUE)

summary(data$Inclination)
```
Eccentricity: do not include it. Prova ad inserire il logaritmo nel modello con altre var discretizzate
```{r}
plot(data$Eccentricity, data$`Effective Lifetime`, xlab='Eccentricity')
hist(data$Eccentricity, xlab='Eccentricity', main='Histogram of Eccentricity', prob = TRUE)

summary(data$Eccentricity)
```
Apogee
```{r}
plot(data$Apogee, data$`Effective Lifetime`, xlab='Apogee')
hist(data$Apogee, xlab='Apogee', main='Histogram of Apogee', prob = TRUE)

summary(data$Apogee)
```
Perigee
```{r}
plot(data$Perigee, data$`Effective Lifetime`, xlab='Perigee')
hist(data$Perigee, xlab='Perigee', main='Histogram of Perigee', prob = TRUE)

summary(data$Perigee)
```
Longitude of GEO:
```{r}
plot(data$`Longitude of GEO`, data$`Effective Lifetime`, xlab='`Longitude of GEO`')
hist(data$`Longitude of GEO`, xlab='`Longitude of GEO`', main='Histogram of `Longitude of GEO`', prob = TRUE)

summary(data$`Longitude of GEO`)
```



Fit the coxph model, keep all numerical variables and only Purpose and Users (due to observation on KM):


Massa, periodo discretizzato, longitude of geo, purpose(.mod?)

Discretize period:
```{r}
data$Periodcat <- cut(data$Period, breaks=c(0, 1000, Inf), labels=c("short", "long"))
```

Modify purpose:
```{r}
purpose.mod <- data$Purpose
id <- which(data$Purpose == 'Navigation' | data$Purpose =='Space Science')
purpose.mod[id] <- 'Earth Observation'
data$Purpose.mod <- factor(purpose.mod)
```


```{r}
time <- data$'Effective Lifetime'
Status <- data$Status
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```



Let's remove least significant covariates once at the time.
```{r}
data$Purpose[which(data$Purpose == "Technology Development" )] = "Communications"
data$Purpose <- factor(data$Purpose)
```

```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```
```{r}
data$Purpose[which(data$Purpose == "Navigation" )] = "Communications"
data$Purpose <- factor(data$Purpose)
```

```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```
```{r}
data$Orbit[which(data$Orbit == "MEO" )] = "Elliptical"
data$Orbit <- factor(data$Orbit)
```

```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```

```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Inclination", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```

```{r}
data$Users[which(data$Users == "Military" )] = "Civil"
data$Users <- factor(data$Users)
```

```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```

```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Inclination", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```


```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```

```{r}
data$Purpose[which(data$Purpose == "Earth Observation" )] = "Communications"
data$Purpose <- factor(data$Purpose)
```

```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = data[,covariates])
summary(cox1)
```



```{r}
test1 <- cox.zph(cox1)
test1
```
```{r}
covariates <- c("Users", "Purpose", "Orbit", "Longitude of GEO", "Perigee", "Apogee", "Period","Mass","Continent")

cox1 <- coxph(Surv(time, Status == 'retired') ~ Users + Purpose + strata(Orbit) + Perigee + Apogee + Period
              + data$`Longitude of GEO` + Mass + Continent, data = data)
summary(cox1)
```

```{r}
test1 <- cox.zph(cox1)
test1
```


Plot of scaled schoenfeld residuals:
```{r}
ggcoxdiagnostics(cox1, type = "scaledsch")
```


