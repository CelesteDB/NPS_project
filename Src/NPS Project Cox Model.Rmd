---
title: "NPS Project cox model"
output: html_document
date: "2023-12-05"
---

### Environment settings

Libraries:
```{r,'error=FALSE', 'warning=FALSE'}
library(readxl)
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
library(readxl)
library(fastDummies)
```

Load data
```{r}
data <- read_excel("../Dataset/JoinDatasets.xlsx", col_names = TRUE)
```


### Dataset exploration

Summary:
```{r}
summary(data)
```

Factorize columns:
```{r}
data$Country <- factor(data$Country, ordered = F)
print('Country')
table(data$Country)

data$Continent <- factor(data$Continent, ordered = F)
print('Continent')
table(data$Continent)

data$Users <- factor(data$Users, ordered = F)
print('Users')
table(data$Users)

data$Purpose <- factor(data$Purpose, ordered = F)
print('Purpose')
table(data$Purpose)

data$Orbit <- factor(data$Orbit, ordered = F)
print('Class of Orbit')
table(data$Orbit)

data$Status <- factor(data$Status, ordered = F)
print('Status')
table(data$Status)
```
Create dummy variables:
```{r}
# USERS : Levels: Civil Commercial Government Military

dummy_data <- dummy_cols(data, select_columns = "Users", remove_first_dummy = TRUE)

# PURPOSE : Levels: Communications Earth Observation Navigation Space Science Technology Development

dummy_data <- dummy_cols(dummy_data, select_columns = "Purpose", remove_first_dummy = TRUE)


# ORBIT : Levels: Elliptical GEO LEO MEO

dummy_data <- dummy_cols(dummy_data, select_columns = "Orbit", remove_first_dummy = TRUE)


# CONTINENT: Levels: Africa Americas Asia Europe Multinational Oceania

dummy_data <- dummy_cols(dummy_data, select_columns = "Continent", remove_first_dummy = TRUE)


# dataset without Purpose, Users, Continent and Orbit
# dummy_data <- dummy_data[,c(1:2,6:17,19:33)]
```

Shuffle observations
```{r}
data <- data[sample(nrow(data)), ]
```

Exploration of numerical variables:

1) Mass: 
```{r}
plot(data$Mass, data$`Effective Lifetime`, xlab='Mass')
hist(data$Mass[which(data$Mass<2000)], xlab='Mass', main='Histogram of Mass', prob = TRUE)

summary(data$Mass)
```

Discretize mass
```{r}
Mass.disc <- cut(data$Mass, breaks=c(0, 500, Inf), labels=c("light", "heavy"))
dummy_data$Mass.disc <- Mass.disc

table(Mass.disc)
# light heavy 
#   531   183 

boxplot(data$`Effective Lifetime`~ Mass.disc)
```


2) Period:
```{r}
plot(data$Period, data$`Effective Lifetime`, xlab='Period')
hist(data$Period[which(data$Period < 2000)], xlab='Period', main='Histogram of Period', prob = TRUE)

summary(data$Period)
```

Discretize period

488 satellites with period < 500
220 satellites with period between 500 and 2000
6 satellites with period > 2000

```{r}
Per.disc <- cut(data$Period, breaks=c(0, 1000, Inf), labels=c("short", "long"))
dummy_data$Per.disc <- Per.disc

table(Per.disc)
# short  long 
#   532   182 

boxplot(data$`Effective Lifetime`~ Per.disc)
```

3) Inclination: 
```{r}
plot(data$Inclination, data$`Effective Lifetime`, xlab='Inclination')
hist(data$Inclination, xlab='Inclination', main='Histogram of Inclination', prob = TRUE)

summary(data$Inclination)
```

Discretize inclination
```{r}
Inc.disc <- cut(data$Inclination, breaks=c(0, 45, 180), labels=c("low", "high"))
dummy_data$Inc.disc <- Inc.disc

table(Inc.disc)
#  low high 
#  188  506 

boxplot(data$`Effective Lifetime`~ Inc.disc)
```

4) Eccentricity:
```{r}
plot(data$Eccentricity, data$`Effective Lifetime`, xlab='Eccentricity')
hist(data$Eccentricity, xlab='Eccentricity', main='Histogram of Eccentricity', prob = TRUE)

summary(data$Eccentricity)
```


5) Apogee
```{r}
plot(data$Apogee, data$`Effective Lifetime`, xlab='Apogee')
hist(data$Apogee, xlab='Apogee', main='Histogram of Apogee', prob = TRUE)

summary(data$Apogee)
```

Discretize apogee
```{r}
Ap.disc <- cut(data$Apogee, breaks=c(0, 25000, Inf), labels=c("low", "high"))
dummy_data$Ap.disc <- Ap.disc

table(Ap.disc)
 # low high 
 # 528  186 

boxplot(data$`Effective Lifetime`~ Ap.disc)
```


6) Perigee
```{r}
plot(data$Perigee, data$`Effective Lifetime`, xlab='Perigee')
hist(data$Perigee, xlab='Perigee', main='Histogram of Perigee', prob = TRUE)

summary(data$Perigee)
```

Discretize perigee
```{r}
Pe.disc <- cut(data$Perigee, breaks=c(0, 10000, Inf), labels=c("low","high"))
dummy_data$Pe.disc <- Pe.disc

table(Pe.disc)
   # low high 
   # 498  216  

boxplot(data$`Effective Lifetime`~ Pe.disc)
```

7) Longitude of GEO:
```{r}
plot(data$`Longitude of GEO`, data$`Effective Lifetime`, xlab='`Longitude of GEO`')
hist(data$`Longitude of GEO`, xlab='`Longitude of GEO`', main='Histogram of `Longitude of GEO`', prob = TRUE)

summary(data$`Longitude of GEO`)
```

Correlation between variables:
```{r}
num <- c("Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period", "Mass")
data_num <- data[,num]

cor(data_num)
# Apogee - Period 0.97263559  
# Perigee - Period 0.88954088 
# Perigee - Inclination -0.82988349   
# Apogee - Perigee 0.78883152     
# Period - Inclination -0.73168416   
# Apogee - Eccentricity 0.67998408  
# Apogee - Inclination -0.65478644    

pairs(data_num, pch = 19)
```

Recall that eccentricity is a function of perigee and apogee

Longitude of geo is where the satellite is wrt greenwich meridian (all satellites are geosynchronous, ie they have same rotational speed as hearth) -> looks useless since all observations are above greenwich meridian 

Period ^ 2 is proportional to a ^ 3, where a = (apogee + perigee)/2

Type of orbit is a classification based on eccentricity and on period

I would therefore keep only period, perigee and apogee(even if they're very correlated) and exclude type of orbit, as well as eccentricity since it summarizes perigee and apogee (and almost all observations have eccentricity = 0)

We'll try to keep inclination and mass too

So we keep: period, perigee, apogee, inclination, mass

Note that due to collinearity we could only keep period, inclination, mass

### COX MODEL

```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

# , "Longitude of GEO" , "Orbit_GEO", "Orbit_LEO", "Orbit_MEO", "Eccentricity",

covariates <- c( "Perigee" ,"Apogee", "Inclination", "Period", "Mass", "Users_Commercial", "Users_Government", "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science", "Purpose_Technology Development", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational", "Continent_Oceania")

n_coef <- length(covariates)

cox1 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox1)
```

Remove `Purpose_Navigation`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c( "Perigee" ,"Apogee", "Inclination", "Period", "Mass", "Users_Commercial", "Users_Government", "Users_Military", "Purpose_Earth Observation", "Purpose_Space Science", "Purpose_Technology Development", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational", "Continent_Oceania")


n_coef <- length(covariates)

cox2 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox2)
```


Inclination is non significant, we try to discretize it 
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c( "Perigee" ,"Apogee", "Inc.disc", "Period", "Mass", "Users_Commercial", "Users_Government", "Users_Military", "Purpose_Earth Observation", "Purpose_Space Science", "Purpose_Technology Development", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational", "Continent_Oceania")


n_coef <- length(covariates)

cox3 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox3)
```

Remove `Inc.disc`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c( "Perigee" ,"Apogee", "Period", "Mass", "Users_Commercial", "Users_Government", "Users_Military", "Purpose_Earth Observation", "Purpose_Space Science", "Purpose_Technology Development", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational", "Continent_Oceania")


n_coef <- length(covariates)

cox4 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox4)
```


Remove `Users_Military`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c( "Perigee" ,"Apogee", "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Earth Observation", "Purpose_Space Science", "Purpose_Technology Development", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational", "Continent_Oceania")


n_coef <- length(covariates)

cox5 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox5)
```


Remove `Purpose_Earth Observation`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c( "Perigee" ,"Apogee", "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Space Science", "Purpose_Technology Development", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational", "Continent_Oceania")


n_coef <- length(covariates)

cox6 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox6)
```



Verify Assumptions:
```{r}
test <- cox.zph(cox6)
test
```
Not verified for Oceania and Europe at 10% 


We try to stratify wrt continents:
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

cox7 <- coxph(Surv(time,status == 'retired') ~ Perigee + Apogee + Period + Mass + Users_Commercial + Users_Government + `Purpose_Space Science` + `Purpose_Technology Development` + strata(dummy_data$Continent), data = dummy_data)

summary(cox7)
```

Verify Assumptions:
```{r}
test <- cox.zph(cox7)
test
```

Not verified for mass, try to discretize it:
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

cox8 <- coxph(Surv(time,status == 'retired') ~ Perigee + Apogee + Period + Mass.disc + Users_Commercial + Users_Government + `Purpose_Space Science` + `Purpose_Technology Development` + strata(dummy_data$Continent), data = dummy_data)

summary(cox8)
```
Mass becomes non significant, remove it
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

cox9 <- coxph(Surv(time,status == 'retired') ~ Perigee + Apogee + Period + Users_Commercial + Users_Government + `Purpose_Space Science` + `Purpose_Technology Development` + strata(dummy_data$Continent), data = dummy_data)

summary(cox9)
```

Verify Assumptions:
```{r}
test <- cox.zph(cox9)
test
```

Since coefficients of period, apogee, perigee are close to 1 (even though the CI of HR doens't contain 1 so these covariates are significant) I try to keep only period:
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

cox10 <- coxph(Surv(time,status == 'retired') ~ Period + Users_Commercial + Users_Government + `Purpose_Space Science` + `Purpose_Technology Development` + strata(dummy_data$Continent), data = dummy_data)

summary(cox10)
```

Verify Assumptions:
```{r}
test <- cox.zph(cox10)
test
```

Anova, AIC and BIC to compare the 2 latest models:
```{r}
lr_test <- anova(cox9, cox10, test = "Chisq")
print(lr_test)

aic_cox9 <- AIC(cox9)
aic_cox10 <- AIC(cox10)

bic_cox9 <- BIC(cox9)
bic_cox10 <- BIC(cox10)

print(c("AIC cox9:", aic_cox9))
print(c("AIC cox10:", aic_cox10))
print(c("BIC cox9:", bic_cox9))
print(c("BIC cox10:", bic_cox10))
```


This results say that it is better to include perigee and apogee in the model -> keep cox9

Visualize HR:
```{r}
ggforest(cox9, data = dummy_data)
```

Residuals
```{r}
ggcoxdiagnostics(cox9, type = "martingale")
ggcoxdiagnostics(cox9, type = "deviance")
ggcoxdiagnostics(cox9, type = "scaledsch")
```


Predict Lifetime for each satellite with coxed function:
```{r}
coxed_cox9 <- coxed::coxed(cox9, newdata = dummy_data, method="npsf", bootstrap = TRUE, B=750)
predicted_lifetime <- coxed_cox9$exp.dur

sorted_lt <- predicted_lifetime[order(predicted_lifetime$exp.dur),]

t <- seq(0, max(dummy_data$`Effective Lifetime`), length = length(sorted_lt$exp.dur))
plot(t, sorted_lt$exp.dur, type = 'l', lwd = 2)
lines(t, sorted_lt$lb)
lines(t, sorted_lt$ub)
```

