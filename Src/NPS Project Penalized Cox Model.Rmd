---
title: "Cox Model"
output: html_document
date: "2023-12-04"
---


```{r}
library(readxl)
data <- read_excel("../Dataset/JoinDatasets.xlsx", col_names = TRUE)
```

Libraries:
```{r,'error=FALSE', 'warning=FALSE'}
library(readxl)
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
```

Summary:
```{r}
summary(data)
```

Rendi colonne factor:
```{r}
data$Country <- factor(data$Country, ordered = F)
print('Country')
table(data$Country)

data$Continent <- factor(data$Continent, ordered = F)
print('Continent')
table(data$Continent)

data$Users <- factor(data$Users, ordered = F)
print('Users')
table(data$Users)

data$Purpose <- factor(data$Purpose, ordered = F)
print('Purpose')
table(data$Purpose)

data$Orbit <- factor(data$Orbit, ordered = F)
print('Class of Orbit')
table(data$Orbit)

data$Status <- factor(data$Status, ordered = F)
print('Status')
table(data$Status)
```

Mischia righe
```{r}
data <- data[sample(nrow(data)), ]
```
Exploration of numerical variables:
```{r}
num <- c("Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period", "Mass")
data_num <- data[,num]

cor(data_num)
# Apogee - Period 0.96672436  
# Perigee - Inclination -0.88628415   
# Perigee - Period 0.8327784  
# Period - Inclination -0.73233046  
# Apogee - Perigee 0.67998408  
# Apogee - Eccentricity 0.67998408  
# Apogee - Inclination -0.60232423  

pairs(data_num)
```
### COX REGRESSION MODEL


```{r}
#install.packages("fastDummies")
library(fastDummies)

# USERS : Levels: Civil Commercial Government Military

dummy_data <- dummy_cols(data, select_columns = "Users", remove_first_dummy = TRUE)

# PURPOSE : Levels: Communications Earth Observation Navigation Space Science Technology Development

dummy_data <- dummy_cols(dummy_data, select_columns = "Purpose", remove_first_dummy = TRUE)


# ORBIT : Levels: Elliptical GEO LEO MEO

dummy_data <- dummy_cols(dummy_data, select_columns = "Orbit", remove_first_dummy = TRUE)


# CONTINENT: Levels: Africa Americas Asia Europe Multinational Oceania

dummy_data <- dummy_cols(dummy_data, select_columns = "Continent", remove_first_dummy = TRUE)


# dataset senza Purpose, Users, Continent and Orbit

dummy_data <- dummy_data[,c(1:2,6:17,19:33)]

```


```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science", "Purpose_Technology Development",                        "Orbit_GEO", "Orbit_LEO",  "Orbit_MEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational",       
                 "Continent_Oceania")

n_coef <- length(covariates)

cox1 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox1)

```

Rimuovo `Purpose_Technology Development`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO","Orbit_MEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox2 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox2)

```

Rimuovo `Orbit_MEO`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox3 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox3)

```


Rimuovo "Purpose_Navigation"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox4 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox4)

```

Rimuovo "Eccentricity"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox5 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox5)

```

Rimuovo "Users_Military"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox6 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox6)

```
Rimuovo "Inclination"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" , "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox7 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox7)

```
Rimuovo "Purpose_Earth observation"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" , "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox8 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox8)

```

Verifichiamo assunzioni:

```{r}
test <- cox.zph(cox8)
test
```


```{r}
# Residui
ggcoxdiagnostics(cox8, type = "scaledsch")
```

Le assunzioni non sono verificate e ho alta variabilità. 
Data l'alta collinearità proviamo penalized cox model.

```{r}
#install.packages("fastDummies")
library(fastDummies)

# USERS : Levels: Civil Commercial Government Military

dummy_data <- dummy_cols(data, select_columns = "Users", remove_first_dummy = TRUE)

# PURPOSE : Levels: Communications Earth Observation Navigation Space Science Technology Development

dummy_data <- dummy_cols(dummy_data, select_columns = "Purpose", remove_first_dummy = TRUE)


# ORBIT : Levels: Elliptical GEO LEO MEO

dummy_data <- dummy_cols(dummy_data, select_columns = "Orbit", remove_first_dummy = TRUE)


# CONTINENT: Levels: Africa Americas Asia Europe Multinational Oceania

dummy_data <- dummy_cols(dummy_data, select_columns = "Continent", remove_first_dummy = TRUE)


# dataset senza Purpose, Users, Continent and Orbit

dummy_data <- dummy_data[,c(1:2,6:17,19:33)]

```

### PENALIZED COX MODEL
Alucni link utili: https://stats.stackexchange.com/questions/416183/cox-regression-with-lasso-regression/416279#416279
https://glmnet.stanford.edu/articles/Coxnet.html#basic-usage-for-right-censored-data


Usiamo pacchetto glmnet

https://cran.r-project.org/web/packages/glmnet/glmnet.pdf
```{r}
library(glmnet)
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

# Crea la formula di sopravvivenza
f <- Surv(time, status == 'retired') ~ . 
covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science", "Purpose_Technology Development",                        "Orbit_GEO", "Orbit_LEO",  "Orbit_MEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational",       
                 "Continent_Oceania")

n_coef = length(covariates)
# Adatta un modello di regressione di Cox penalizzato usando glmnet
# alpha = 1 per la penalizzazione L2 (Ridge)
# alpha = 0 per la penalizzazione L1 (Lasso)
cox_model <- cv.glmnet(x = as.matrix(dummy_data[,covariates]), y = Surv(time,status == 'retired'), family = "cox", alpha = 0)

print(cox_model)

bestlambda <- cox_model$lambda.min # con lasso lambda è quasi zero
plot(cox_model)
abline(v=log(bestlambda), lty=1)

fitAtLmin <- glmnet(x = as.matrix(dummy_data[,covariates]),  y = Surv(time,status == 'retired') ,family="cox",lambda=bestlambda)
coef <- coef(fitAtLmin)
variable_sel <- which(coef != 0) # Uso Lasso per variable selection

## fix those coefficient values into a Cox model
coxL <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates[variable_sel]],
    init=as.numeric(coef(fitAtLmin)[variable_sel]), ## specify coefficient values
    iter.max=0) ## force the software to keep those values
summary(coxL)


```

Verifica delle assunzioni
```{r}
test <- cox.zph(coxL)
test


# Residui
ggcoxdiagnostics(coxL, type = "scaledsch")
```
```{r}

## fix those coefficient values into a Cox model
covariates2 <- covariates[variable_sel]
names(covariates2)
covariates2 <- c ("Perigee", "Apogee","Inclination","Mass","Users_Commercial","Users_Government","Purpose_Navigation", "Purpose_Technology Development", "Orbit_LEO", "Continent_Asia")      

coxL <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates2])
summary(coxL)


```
Rimuovo Purpose_Navigation

```{r}
covariates2 <- c ("Perigee", "Apogee","Inclination","Mass","Users_Commercial","Users_Government", "Purpose_Technology Development", "Orbit_LEO", "Continent_Asia")      

coxL <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates2])
summary(coxL)
```

Rimuovo Orbit_Leo
```{r}
covariates2 <- c ("Perigee", "Apogee","Inclination","Mass","Users_Commercial","Users_Government", "Purpose_Technology Development", "Continent_Asia")      

coxL <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates2])
summary(coxL)
```

Rmuovo inclination
```{r}
covariates2 <- c ("Perigee", "Apogee","Mass","Users_Commercial","Users_Government", "Purpose_Technology Development", "Continent_Asia")      

coxL <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates2])
summary(coxL)
```
Verifico assunzioni
```{r}
test <- cox.zph(coxL)
test


# Residui
ggcoxdiagnostics(coxL, type = "scaledsch")
```




PDF LIBRERIA: Penalized
https://cran.r-project.org/web/packages/penalized/penalized.pdf
```{r}
install.packages("penalized")
library(penalized)

time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science", "Purpose_Technology Development",                        "Orbit_GEO", "Orbit_LEO",  "Orbit_MEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational",       
                 "Continent_Oceania")

n_coef = length(covariates)

mod_cox <- optL1 (Surv(time,status == 'retired')~ .,data = dummy_data[,covariates], model = "cox", fold  = 10, 
                  epsilon = 1e-10, standardize = FALSE, trace = TRUE)

bestlam <- mod_cox$lambda
coefficients(mod_cox$fullfit)
plot(mod_cox$predictions)

## fix those coefficient values into a Cox model
coxL <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates],
    init=as.numeric(coef(mod_cox$fullfit)), ## specify coefficient values
    iter.max=0) ## force the software to keep those values
summary(coxL)

# for prediction --> predict

```
Verifica delle assunzioni
```{r}
test <- cox.zph(coxL)

# Residui
ggcoxdiagnostics(coxL, type = "scaledsch")
```














































