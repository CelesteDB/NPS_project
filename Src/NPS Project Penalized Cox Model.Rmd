---
title: "Cox Model"
output: html_document
date: "2023-12-04"
---


```{r}
library(readxl)
data <- read_excel("../Dataset/JoinDatasets.xlsx", col_names = TRUE)
```

Libraries:
```{r,'error=FALSE', 'warning=FALSE'}
library(readxl)
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
```

Summary:
```{r}
summary(data)
```

Rendi colonne factor:
```{r}
data$Country <- factor(data$Country, ordered = F)
print('Country')
table(data$Country)

data$Continent <- factor(data$Continent, ordered = F)
print('Continent')
table(data$Continent)

data$Users <- factor(data$Users, ordered = F)
print('Users')
table(data$Users)

data$Purpose <- factor(data$Purpose, ordered = F)
print('Purpose')
table(data$Purpose)

data$Orbit <- factor(data$Orbit, ordered = F)
print('Class of Orbit')
table(data$Orbit)

data$Status <- factor(data$Status, ordered = F)
print('Status')
table(data$Status)
```

Mischia righe
```{r}
data <- data[sample(nrow(data)), ]
```

Data l'alta collinearità proviamo penalized cox model.

```{r}
#install.packages("fastDummies")
library(fastDummies)

# USERS : Levels: Civil Commercial Government Military

dummy_data <- dummy_cols(data, select_columns = "Users", remove_first_dummy = TRUE)

# PURPOSE : Levels: Communications Earth Observation Navigation Space Science Technology Development

dummy_data <- dummy_cols(dummy_data, select_columns = "Purpose", remove_first_dummy = TRUE)


# ORBIT : Levels: Elliptical GEO LEO MEO

dummy_data <- dummy_cols(dummy_data, select_columns = "Orbit", remove_first_dummy = TRUE)


# CONTINENT: Levels: Africa Americas Asia Europe Multinational Oceania

dummy_data <- dummy_cols(dummy_data, select_columns = "Continent", remove_first_dummy = TRUE)


# dataset senza Purpose, Users, Continent and Orbit

dummy_data <- dummy_data[,c(1:2,6:17,19:33)]

```

### PENALIZED COX MODEL 
Alucni link utili: 
-https://stats.stackexchange.com/questions/416183/cox-regression-with-lasso-regression/416279#416279
-https://glmnet.stanford.edu/articles/Coxnet.html#basic-usage-for-right-censored-data
-https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7962780/#sup1

Usiamo pacchetto glmnet

https://cran.r-project.org/web/packages/glmnet/glmnet.pdf
```{r}
library(glmnet)
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

# Crea la formula di sopravvivenza
f <- Surv(time, status == 'retired') ~ . 
covariates <-
  c(
    "Longitude of GEO" ,
    "Perigee" ,
    "Apogee",
    "Eccentricity" ,
    "Inclination",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Users_Military",
    "Purpose_Earth Observation",
    "Purpose_Navigation",
    "Purpose_Space Science",
    "Purpose_Technology Development",
    "Orbit_GEO",
    "Orbit_LEO",
    "Orbit_MEO",
    "Continent_Americas",
    "Continent_Asia",
    "Continent_Europe",
    "Continent_Multinational",
    "Continent_Oceania"
  )

n_coef = length(covariates)
lambda.grid <- 10^seq(2, -5 ,length = 100)

# Adatta un modello di regressione di Cox penalizzato usando glmnet
# alpha = 1 per la penalizzazione L2 (Ridge)
# alpha = 0 per la penalizzazione L1 (Lasso)
cox_model <- cv.glmnet(x = as.matrix(dummy_data[,covariates]), y = Surv(time,status == 'retired'), family = "cox", alpha = 1, lambda = lambda.grid)

# PROVA A CAMBIARE VALORE DI ALPHA ---> ELASTIC NET FORSE è MEGLIO

print(cox_model)

bestlambda <- cox_model$lambda.min # con lasso lambda è quasi zero
plot(cox_model)
abline(v=log(bestlambda), lty=1)

fitAtLmin <- glmnet(x = as.matrix(dummy_data[,covariates]),  y = Surv(time,status == 'retired') ,family="cox",lambda=bestlambda)
coef <- coef(fitAtLmin)

```
The predictors selected by the elastic net-penalized model were then included in an unpenalized cox proportional hazards regression model to establish a baseline for comparison during model approximation. The baseline model was then reduced by backward elimination (see Supplementary Material for a full account). GUARDA https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7962780/#sup1


```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Military",
    "Users_Government",
    "Purpose_Earth Observation",
    "Purpose_Navigation",
    "Purpose_Space Science",
    "Purpose_Technology Development",
    "Orbit_LEO",
    "Continent_Americas",
    "Continent_Europe",
    "Continent_Multinational",
    "Continent_Oceania"
    )

cox1 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox1)
```

Rimuovo purpose_Navigation

```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Military",
    "Users_Government",
    "Purpose_Earth Observation",
    "Purpose_Space Science",
    "Purpose_Technology Development",
    "Orbit_LEO",
    "Continent_Americas",
    "Continent_Europe",
    "Continent_Multinational",
    "Continent_Oceania"
    )

cox2 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox2)
```

Tolgo Users_Military

```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Purpose_Earth Observation",
    "Purpose_Space Science",
    "Purpose_Technology Development",
    "Orbit_LEO",
    "Continent_Americas",
    "Continent_Europe",
    "Continent_Multinational",
    "Continent_Oceania"
    )

cox3 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox3)
```

Tolgo continent_Oceania
```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Purpose_Earth Observation",
    "Purpose_Space Science",
    "Purpose_Technology Development",
    "Orbit_LEO",
    "Continent_Americas",
    "Continent_Europe",
    "Continent_Multinational"
    )

cox4 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox4)
```

Tolgo orbit Leo

```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Purpose_Earth Observation",
    "Purpose_Space Science",
    "Purpose_Technology Development",
    "Continent_Americas",
    "Continent_Europe",
    "Continent_Multinational"
    )

cox5 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox5)
```

Tolgo Purpose Earth observation

```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Purpose_Space Science",
    "Purpose_Technology Development",
    "Continent_Americas",
    "Continent_Europe",
    "Continent_Multinational"
    )

cox6 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox6)
```

Tolgo Purpose tech dev
```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Purpose_Space Science",
    "Continent_Americas",
    "Continent_Europe",
    "Continent_Multinational"
    )

cox7 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox7)
```

Tolgo Continent Europe
```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Purpose_Space Science",
    "Continent_Americas",
    "Continent_Multinational"
    )

cox8 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox8)
```
Tolgo Continent Multinomial
```{r}
time <- dummy_data$`Effective Lifetime`
Status <- dummy_data$Status

variable_sel <-c(  # con coef != 0
    "Longitude of GEO",
    "Apogee",
    "Eccentricity",
    "Period",
    "Mass",
    "Users_Commercial",
    "Users_Government",
    "Purpose_Space Science",
    "Continent_Americas"
    )

cox9 <- coxph(Surv(time, Status == 'retired') ~ . , data = dummy_data[,variable_sel])
summary(cox9)
```


Verifica delle assunzioni
```{r}
test <- cox.zph(cox9)
test


# Residui
ggcoxdiagnostics(cox9, type = "scaledsch")
```


### COX PENALIZED MODEL + DISCRETE VARIABLES ( vedi file cox model + discrete var)
Agiamo nello stesso modo di prima ma discretizziamo le variabili --> DA FARE

Discretiziamo la massa

```{r}
Massa.disc <- cut(data$Mass, breaks=c(0, 1000, Inf), labels=c("light", "heavy"))
dummy_data$Mass.disc <- Massa.disc

```

Discretiziamo il periodo

```{r}
Per.disc <- cut(data$Period, breaks=c(0, 500, 1000, Inf), labels=c("short", "medium", "long"))
dummy_data$Per.disc <- Per.disc

```

Discretiziamo l'inclination

```{r}
Inc.disc <- cut(data$Inclination, breaks=c(-Inf, 40, 70, Inf), labels=c("low", "medium", "high"))
dummy_data$Inc.disc <- Inc.disc

```

Discretiziamo Apogeo

```{r}
Ap.disc <- cut(data$Apogee, breaks=c(0, 25000, Inf), labels=c("low", "high"))
dummy_data$Ap.disc <- Ap.disc

```

Discretiziamo Perigee

```{r}
Pe.disc <- cut(data$Perigee, breaks=c(0, 5000, 25000, Inf), labels=c("low","medium","high"))
dummy_data$Pe.disc <- Pe.disc

```


Creo variabili dummy
```{r}

# MASS: Levels: light heavy

dummy_data <- dummy_cols(dummy_data, select_columns = "Mass.disc", remove_first_dummy = TRUE)

# PERIOD: Levels: short medium long 

dummy_data <- dummy_cols(dummy_data, select_columns = "Per.disc", remove_first_dummy = TRUE)

# INCLINATION: Levels: low medium high 

dummy_data <- dummy_cols(dummy_data, select_columns = "Inc.disc", remove_first_dummy = TRUE)

# PERIGEE: Levels: low medium high  

dummy_data <- dummy_cols(dummy_data, select_columns = "Pe.disc", remove_first_dummy = TRUE)

# APOGEE: Levels: low high

dummy_data <- dummy_cols(dummy_data, select_columns = "Ap.disc", remove_first_dummy = TRUE)
```


```{r}
# dataset senza Purpose, Users, Continent, Orbit, Mass, Period,  Inclination, Apogee and Perigee

dummy_data <- dummy_data[,c(1:2,6,9,12:16,19:33, 39:46)]

```































