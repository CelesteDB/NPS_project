---
title: "NPS Project cox model standard"
output: html_document
date: "2023-12-05"
---

```{r}
library(readxl)
data <- read_excel("../Dataset/JoinDatasets.xlsx", col_names = TRUE)
```

Libraries:
```{r,'error=FALSE', 'warning=FALSE'}
library(readxl)
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
```

Summary:
```{r}
summary(data)
```

Rendi colonne factor:
```{r}
data$Country <- factor(data$Country, ordered = F)
print('Country')
table(data$Country)

data$Continent <- factor(data$Continent, ordered = F)
print('Continent')
table(data$Continent)

data$Users <- factor(data$Users, ordered = F)
print('Users')
table(data$Users)

data$Purpose <- factor(data$Purpose, ordered = F)
print('Purpose')
table(data$Purpose)

data$Orbit <- factor(data$Orbit, ordered = F)
print('Class of Orbit')
table(data$Orbit)

data$Status <- factor(data$Status, ordered = F)
print('Status')
table(data$Status)
```
Mischia righe
```{r}
data <- data[sample(nrow(data)), ]
```

Exploration of numerical variables:

Recall that eccentricity is a function of perigee and apogee

Longitude of geo is where the satellite is wrt greenwich meridian (all satellites are geosynchronous, ie they have same rotational speed as hearth)

Period ^ 2 is proportional to a ^ 3, where a = (apogee + perigee)/2

Type of orbit is a classification based on eccentricity

I would therefore keep only type of orbit and exclude eccentricity, as well as perigee and apogee since they are very correlated with period and type of orbit summarizes them

```{r}
num <- c("Longitude of GEO", "Perigee", "Apogee", "Eccentricity", "Inclination", "Period", "Mass")
data_num <- data[,num]

cor(data_num)
# Apogee - Period 0.97263559  
# Perigee - Period 0.88954088 
# Perigee - Inclination -0.82988349   
# Apogee - Perigee 0.78883152     
# Period - Inclination -0.73168416   
# Apogee - Eccentricity 0.67998408  
# Apogee - Inclination -0.65478644    

pairs(data_num, pch = 19)
```

### COX MODEL


```{r}
#install.packages("fastDummies")
library(fastDummies)

# USERS : Levels: Civil Commercial Government Military

dummy_data <- dummy_cols(data, select_columns = "Users", remove_first_dummy = TRUE)

# PURPOSE : Levels: Communications Earth Observation Navigation Space Science Technology Development

dummy_data <- dummy_cols(dummy_data, select_columns = "Purpose", remove_first_dummy = TRUE)


# ORBIT : Levels: Elliptical GEO LEO MEO

dummy_data <- dummy_cols(dummy_data, select_columns = "Orbit", remove_first_dummy = TRUE)


# CONTINENT: Levels: Africa Americas Asia Europe Multinational Oceania

dummy_data <- dummy_cols(dummy_data, select_columns = "Continent", remove_first_dummy = TRUE)


# dataset senza Purpose, Users, Continent and Orbit

dummy_data <- dummy_data[,c(1:2,6:17,19:33)]
```


```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

# , "Eccentricity", "Longitude of GEO", "Perigee" ,"Apogee" ,

covariates <- c( "Inclination", "Period", "Mass", "Users_Commercial", "Users_Government", "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science", "Purpose_Technology Development", "Orbit_GEO", "Orbit_LEO",  "Orbit_MEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational", "Continent_Oceania")

n_coef <- length(covariates)

cox1 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox1)
```

Rimuovo `Purpose_Technology Development`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO","Orbit_MEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox2 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox2)

```

Rimuovo `Orbit_MEO`
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Navigation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox3 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox3)
```


Rimuovo "Purpose_Navigation"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee", "Eccentricity" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox4 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox4)

```

Rimuovo "Eccentricity"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government",                      "Users_Military", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO",                    "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox5 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox5)

```

Rimuovo "Users_Military"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" ,"Inclination", "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox6 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox6)

```
Rimuovo "Inclination"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" , "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Earth Observation", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox7 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox7)

```

Rimuovo "Purpose_Earth observation"
```{r}
time <- dummy_data$`Effective Lifetime`
status <- dummy_data$Status

covariates <- c("Longitude of GEO" , "Perigee" ,"Apogee" , "Period", "Mass", "Users_Commercial", "Users_Government", "Purpose_Space Science","Orbit_GEO", "Orbit_LEO", "Continent_Americas", "Continent_Asia", "Continent_Europe", "Continent_Multinational","Continent_Oceania")

n_coef <- length(covariates)

cox8 <- coxph(Surv(time,status == 'retired') ~ ., data = dummy_data[,covariates])
summary(cox8)

```

Verifichiamo assunzioni:

```{r}
test <- cox.zph(cox8)
test
```


```{r}
# Residui
ggcoxdiagnostics(cox8, type = "scaledsch")
```