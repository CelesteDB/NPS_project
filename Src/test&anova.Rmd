---
title: "test&anova"
output: html_document
date: "2023-11-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages("openxlsx")
#library("openxlsx")
library(readxl)
data <- read_excel("../Dataset/JoinDatasets.xlsx", col_names = TRUE)


data=data[sample(nrow(data)),] 
head(data)
dim(data)

#tolgo le osservazioni senza expected lifetime
id=which(is.na(data$`Expected Lifetime`))
data=data[-id,]

B = 1e3
seed = 26111992
```

PERMUTATIONAL ONE-WAY ANOVA EXP-LIFETIME -\> CONTINENT

```{r}
explife = data$`Expected Lifetime`
continent = as.factor(data$Continent)
g = nlevels(continent)
n = dim(data)[1]

plot(continent, explife, xlab='continent',col=rainbow(g),main='Original Data')


fit_c <- aov(explife ~ continent)
summary(fit_c)

T0 <- summary(fit_c)[[1]][1,4]  # extract the test statistic
T0


T_stat <- numeric(B) 

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  explife_perm <- explife[permutation]
  fit_perm <- aov(explife_perm ~ continent)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}


hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)

plot(ecdf(T_stat),xlim=c(-1,20))
abline(v=T0,col=3,lwd=4)

# p-value
p_val <- sum(T_stat>=T0)/B
p_val #0.006
```

There is significant difference on the expected lifetime between continents.

PERMUTATIONAL ONE-WAY ANOVA EXP-LIFETIME -\> PURPOSE

```{r}

purpose = as.factor(data$Purpose)
g = nlevels(purpose)
n = dim(data)[1]

plot(purpose, explife, xlab='purpose',col=rainbow(g),main='Original Data')


fit_p <- aov(explife ~ purpose)
summary(fit_p)

T0 <- summary(fit_p)[[1]][1,4]  # extract the test statistic
T0


T_stat <- numeric(B) 

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  explife_perm <- explife[permutation]
  fit_perm <- aov(explife_perm ~ purpose)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}


hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)

plot(ecdf(T_stat),xlim=c(-1,80))
abline(v=T0,col=3,lwd=4)

# p-value
p_val <- sum(T_stat>=T0)/B
p_val #0

```

There is significant difference on the expected lifetime between purposes.

PERMUTATIONAL ONE-WAY ANOVA EXP-LIFETIME -\> USERS

```{r}

users = as.factor(data$Users)
g = nlevels(users)
n = dim(data)[1]

plot(users, explife, xlab='users',col=rainbow(g),main='Original Data')


fit_u <- aov(explife ~ users)
summary(fit_u)

T0 <- summary(fit_u)[[1]][1,4]  # extract the test statistic
T0


T_stat <- numeric(B) 

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  explife_perm <- explife[permutation]
  fit_perm <- aov(explife_perm ~ users)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}


hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)

plot(ecdf(T_stat),xlim=c(-1,80))
abline(v=T0,col=3,lwd=4)

# p-value
p_val <- sum(T_stat>=T0)/B
p_val #0

```

There is significant difference on the expected lifetime between users.

PERMUTATIONAL TWO-WAYS ANOVA EXP-LIFETIME -\> CONTINENT-PURPOSE

```{r}
summary.aov(aov(explife ~ continent + purpose + continent:purpose)) 
T0_cp <- summary.aov(aov(explife ~ continent + purpose + continent:purpose))[[1]][3,4]
T0_cp

aov.H0cp <- aov(explife ~ continent + purpose) #reduced model 
aov.H0cp
residuals.H0cp <- aov.H0cp$residuals


T_cp<- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  residuals.H0cp <- residuals.H0cp[permutation]
  explife.perm.H0cp <- aov.H0cp$fitted + residuals.H0cp
  T_cp[perm] <- summary.aov(aov(explife.perm.H0cp ~ continent + purpose + continent:purpose))[[1]][3,4]
}

sum(T_cp >= T0_cp)/B
```

The interaction between continent and purpose is significative at a confidence level of alpha=0.05 (p-value = 0.021)

PERMUTATIONAL TWO-WAYS ANOVA EXP-LIFETIME -\> USERS-PURPOSE

```{r}
summary.aov(aov(explife ~ users + purpose + users:purpose)) 
T0_cp <- summary.aov(aov(explife ~ users + purpose + users:purpose))[[1]][3,4]
T0_cp

aov.H0cp <- aov(explife ~ users + purpose) #reduced model 
aov.H0cp
residuals.H0cp <- aov.H0cp$residuals


T_cp<- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  residuals.H0cp <- residuals.H0cp[permutation]
  explife.perm.H0cp <- aov.H0cp$fitted + residuals.H0cp
  T_cp[perm] <- summary.aov(aov(explife.perm.H0cp ~ users + purpose + users:purpose))[[1]][3,4]
}

sum(T_cp >= T0_cp)/B
```

The interaction between users and purpose is significative at a confidence level of alpha=0.05 (p-value = 0.048)

------------------------------------------------------------------------

I create a fictitious predicted lifetime

```{r}
mu <- 11.27487
sig <- 4.2712
predlife <- rnorm(n, mu, sig)
```

MANN-WHITNEY U TEST

Independence assumption is not verified !!!

H0: X and Y have the same distribution vs H1: P(X\>Y) != 0.5

```{r}
alpha=0.05

p.value <- wilcox.test(explife,y=predlife, paired=F, conf.level = 1-alpha)$p.value
p.value 
```

Now we consider predlife and explife as paired data

```{r}

p.value <- wilcox.test(explife,y=predlife, paired=T, conf.level = 1-alpha)$p.value
p.value
```

PERMUTATION TEST

Independence assumption is not verified !!!

H0: X and Y have the same distribution vs H1: X and Y have different distributions

```{r}
perm_t_test=function(x,y,iter=1e3){ #conditional MC -> n.iterations
  
  T0=abs(mean(x)-mean(y))  # define the test statistic
  T_stat=numeric(iter) # a vector to store the values of each iteration
  x_pooled=c(x,y) # pooled sample
  n=length(x_pooled)
  n1=length(x)
  
  for(perm in 1:iter){ # loop for conditional MC
    # permutation:
    permutation <- sample(1:n)
    x_perm <- x_pooled[permutation]
    x1_perm <- x_perm[1:n1]
    x2_perm <- x_perm[(n1+1):n]
    # test statistic:
    T_stat[perm] <- abs(mean(x1_perm) - mean(x2_perm))
    
  }
  
  # p-value
  p_val <- sum(T_stat>=T0)/iter
  return(p_val)
}


p.value <- perm_t_test(explife, predlife)
p.value

```

TWO SAMPLE PAIRED UNIVARIATE PERMUTATION TEST

H0 : E[ X - Y ] = 0 vs H1: E[ X - Y] != 0

```{r}
t1=explife
t2=predlife
p=1
n1=n
n2=n
t1.mean <- mean(t1)
t2.mean <- mean(t2)
t1.cov  <-  var(t1)
t2.cov  <-  var(t2)
Sp      <- ((n1-1)*t1.cov + (n2-1)*t2.cov)/(n1+n2-2)  # pooled cov matrix
Spinv   <- solve(Sp)

delta.0 <- 0

diff <- t1-t2
diff.mean <- mean(diff)
diff.cov <- var(diff)
diff.invcov <- solve(diff.cov)

T20 <- as.numeric(t(diff.mean-delta.0)  %*% (diff.mean-delta.0))

T2 <- numeric(B)
for(perm in 1:B)
  {
  # Random permutation
  # obs: exchanging data within couples means changing the sign of the difference
  signs.perm <- rbinom(n1, 1, 0.5)*2 - 1
  
  diff_perm <- diff * matrix(signs.perm,nrow=n1,ncol=p,byrow=FALSE)
  diff.mean_perm <- mean(diff_perm)
  diff.cov_perm <- cov(diff_perm)
  diff.invcov_perm <- solve(diff.cov_perm)
  
  T2[perm] <- as.numeric(t(diff.mean_perm-delta.0) %*% (diff.mean_perm-delta.0))
}

hist(T2,xlim=range(c(T2,T20)),breaks=100)
abline(v=T20,col=3,lwd=4)

plot(ecdf(T2))
abline(v=T20,col=3,lwd=4)

p_val <- sum(T2>=T20)/B
p_val
```

ALTERNATIVE:

Instead of performing inference on the distribution of the difference, we treat them "separately". We have 2\^N different permutations, since the **exchangeability is only within the pairs**. We choose as test statistic the norm of the differences of the means of both samples.

```{r}
T20 <- norm(as.matrix(mean(t1) - mean(t2)))

T2 <- numeric(B)
t.full <- rbind(t1, t2)
for(perm in 1:B)
  {
  # Random permutation
  # N.B. exchangeability is only within pairs
  perm.indices.t1 <- seq(1, n) + n * rbinom(n,1, 0.5)
  t1.perm <- t.full[perm.indices.t1]
  t2.perm <- t.full[-perm.indices.t1]
  
  T2[perm] <- norm(as.matrix(((mean(t1.perm)) - mean(t2.perm))))
}

hist(T2,xlim=range(c(T2,T20)),breaks=100)
abline(v=T20,col=3,lwd=4)

plot(ecdf(T2))
abline(v=T20,col=3,lwd=4)

# p-value
p_val <- sum(T2>=T20)/B
p_val
```

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

REGRESSION for the difference explife - predlife

```{r}

users = as.factor(data$Users)
purpose = as.factor(data$Purpose)
continent = as.factor(data$Continent)
orbit = as.factor(data$Orbit)
diff = explife - predlife

attach(data)
result <- lm( diff ~ users + purpose + continent + Perigee + Apogee + Period )
summary(result)

# .... permutations
# T0glob, and then single T0s

```

DDPLOT to compare the 2 populations

```{r}

result <- lm( explife ~ users + purpose + continent + Perigee + Apogee + Period )
n <- length(result$residuals)

# now we comparew the explife with a normal distribution
normal <- as.matrix(rnorm(n, sd=summary.lm(result)$sigma))  # unbiased estimate of residual variance

DepthProc::ddPlot(x = as.matrix(normal), # use as.matrix since ddplot usually receives multivariate data
                  y = as.matrix(as.matrix(result$residuals)),depth_params = list(method='Tukey'))
```

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

PERMUTATIONAL CONFIDENCE INTERVALS

Let's use the two sample paired univariate permutation test

```{r}

t1=explife
t2=predlife
diff <- t1-t2

test1 <- function(diff, delta.0, B = 1000) {
  
  data_trans <- diff - delta.0
  T0 <- mean(data_trans)*mean(data_trans)
  T_perm <- numeric(B)
  n1 <- length(diff)
  p <-1 
  
  
  # diff.mean <- mean(diff)
  # diff.cov <- var(diff)
  # diff.invcov <- solve(diff.cov)
  # n1 <- length(diff)
  # p <- 1
  # 
  # T20 <- as.numeric(t(diff.mean-delta.0)  %*% (diff.mean-delta.0))
  # 
  # T2 <- numeric(B)
  for(perm in 1:B)
    {
    # Random permutation
    # obs: exchanging data within couples means changing the sign of the difference
    signs.perm <- rbinom(n1, 1, 0.5)*2 - 1
    data_trans_perm <- data_trans * signs.perm
    T_perm[perm] <- mean(data_trans_perm)*mean(data_trans_perm)
    
    # diff_perm <- diff * matrix(signs.perm,nrow=n1,ncol=p,byrow=FALSE)
    # diff.mean_perm <- mean(diff_perm)
    # diff.cov_perm <- cov(diff_perm)
    # diff.invcov_perm <- solve(diff.cov_perm)
    # 
    # T2[perm] <- as.numeric(t(diff.mean_perm-delta.0) %*% (diff.mean_perm-delta.0))
  }
  
  p_val <- sum(T_perm >= T0)/B
  #p_val <- sum(T2>=T20)/B
  
  return(p_val)

}


grid=seq(-60,5,by=0.1)
length(grid)

library(pbapply)
library(parallel)

n_cores <- detectCores()
n_cores

cl = makeCluster(n_cores)

clusterExport(cl,varlist=list("diff","test1"))

perm_wrapper <- function(grid_point) {
  test1(diff, grid_point, B=2000)  
}

pval_function <- pbsapply(grid, perm_wrapper, cl = cl)

# pval_function <- numeric(length(grid))
# i = 0
# for (theta in grid) {
#   pval_function[i] = test1(theta)
#   i = i+1
# }


alpha <- 0.05  # set the significance level
plot(grid, pval_function, type = "l")  # plot p-value function
values.within.CI <- grid[pval_function > alpha]
CI <- range(values.within.CI)  # obtain the confidence interval
abline(v=CI[1], col="red")
abline(v=CI[2], col="red")
```

BOOTSTRAP DISTRIBUTION & CONFIDENCE INTERVALS for the mean of the difference

```{r}

T.obs <- mean(diff)

cl=makeCluster(parallel::detectCores()/2)
clusterExport(cl=cl,list('diff'))

T.boot=pbreplicate(B,  
                   mean(sample(diff, replace = T)),
                   cl=cl)

plot(ecdf(T.boot), main='Sample mean of the difference')
abline(v = T.obs, lty=2)

```

Probability that the difference between the explife and the predlife (" amount of lie ") is \< x years wrt x years

ex: probability that explife-predlife \< -3 (i.e the explife is underestimated by more than 3 years) is about 0.005.

Intervals: ...
