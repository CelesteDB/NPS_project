---
title: "test&anova"
output: html_document
date: "2023-11-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages("openxlsx")
#library("openxlsx")
#library(readxl)
#data <- read_excel("../Dataset/JoinDatasets.xlsx", col_names = TRUE)


data=data[sample(nrow(data)),] 
head(data)
dim(data)

#tolgo le osservazioni senza expected lifetime
id=which(is.na(data$`Expected Lifetime`))
data=data[-id,]

B = 1e3
seed = 26111992
```

PERMUTATIONAL ONE-WAY ANOVA EXP-LIFETIME -\> CONTINENT

```{r}
explife = data$`Expected Lifetime`
continent = as.factor(data$Continent)
g = nlevels(continent)
n = dim(data)[1]

plot(continent, explife, xlab='continent',col=rainbow(g),main='Original Data')


fit_c <- aov(explife ~ continent)
summary(fit_c)

T0 <- summary(fit_c)[[1]][1,4]  # extract the test statistic
T0


T_stat <- numeric(B) 

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  explife_perm <- explife[permutation]
  fit_perm <- aov(explife_perm ~ continent)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}


hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)

plot(ecdf(T_stat),xlim=c(-1,20))
abline(v=T0,col=3,lwd=4)

# p-value
p_val <- sum(T_stat>=T0)/B
p_val #0.006
```

There is significant difference on the expected lifetime between continents.

PERMUTATIONAL ONE-WAY ANOVA EXP-LIFETIME -\> PURPOSE

```{r}

purpose = as.factor(data$Purpose)
g = nlevels(purpose)
n = dim(data)[1]

plot(purpose, explife, xlab='purpose',col=rainbow(g),main='Original Data')


fit_p <- aov(explife ~ purpose)
summary(fit_p)

T0 <- summary(fit_p)[[1]][1,4]  # extract the test statistic
T0


T_stat <- numeric(B) 

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  explife_perm <- explife[permutation]
  fit_perm <- aov(explife_perm ~ purpose)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}


hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)

plot(ecdf(T_stat),xlim=c(-1,80))
abline(v=T0,col=3,lwd=4)

# p-value
p_val <- sum(T_stat>=T0)/B
p_val #0

```

There is significant difference on the expected lifetime between purposes.

PERMUTATIONAL ONE-WAY ANOVA EXP-LIFETIME -\> USERS

```{r}

users = as.factor(data$Users)
g = nlevels(users)
n = dim(data)[1]

plot(users, explife, xlab='users',col=rainbow(g),main='Original Data')


fit_u <- aov(explife ~ users)
summary(fit_u)

T0 <- summary(fit_u)[[1]][1,4]  # extract the test statistic
T0


T_stat <- numeric(B) 

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  explife_perm <- explife[permutation]
  fit_perm <- aov(explife_perm ~ users)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}


hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)

plot(ecdf(T_stat),xlim=c(-1,80))
abline(v=T0,col=3,lwd=4)

# p-value
p_val <- sum(T_stat>=T0)/B
p_val #0

```

There is significant difference on the expected lifetime between users.

PERMUTATIONAL TWO-WAYS ANOVA EXP-LIFETIME -\> CONTINENT-PURPOSE

```{r}
summary.aov(aov(explife ~ continent + purpose + continent:purpose)) 
T0_cp <- summary.aov(aov(explife ~ continent + purpose + continent:purpose))[[1]][3,4]
T0_cp

aov.H0cp <- aov(explife ~ continent + purpose) #reduced model 
aov.H0cp
residuals.H0cp <- aov.H0cp$residuals


T_cp<- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  residuals.H0cp <- residuals.H0cp[permutation]
  explife.perm.H0cp <- aov.H0cp$fitted + residuals.H0cp
  T_cp[perm] <- summary.aov(aov(explife.perm.H0cp ~ continent + purpose + continent:purpose))[[1]][3,4]
}

sum(T_cp >= T0_cp)/B
```

The interaction between continent and purpose is significative at a confidence level of alpha=0.05 (p-value = 0.021)

PERMUTATIONAL TWO-WAYS ANOVA EXP-LIFETIME -\> USERS-PURPOSE

```{r}
summary.aov(aov(explife ~ users + purpose + users:purpose)) 
T0_cp <- summary.aov(aov(explife ~ users + purpose + users:purpose))[[1]][3,4]
T0_cp

aov.H0cp <- aov(explife ~ users + purpose) #reduced model 
aov.H0cp
residuals.H0cp <- aov.H0cp$residuals


T_cp<- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  residuals.H0cp <- residuals.H0cp[permutation]
  explife.perm.H0cp <- aov.H0cp$fitted + residuals.H0cp
  T_cp[perm] <- summary.aov(aov(explife.perm.H0cp ~ users + purpose + users:purpose))[[1]][3,4]
}

sum(T_cp >= T0_cp)/B
```

The interaction between users and purpose is significative at a confidence level of alpha=0.05 (p-value = 0.048)

------------------------------------------------------------------------

I create a fictitious predicted lifetime

```{r}
mu <- 11.27487
sig <- 4.2712
predlife <- rnorm(n, mu, sig)
```

MANN-WHITNEY U TEST

Independence assumption is not verified !!!

H0: X and Y have the same distribution vs H1: P(X\>Y) != 0.5

```{r}
alpha=0.05

p.value <- wilcox.test(explife,y=predlife, paired=F, conf.level = 1-alpha)$p.value
p.value 
```

Now we consider predlife and explife as paired data

```{r}

p.value <- wilcox.test(explife,y=predlife, paired=T, conf.level = 1-alpha)$p.value
p.value
```

PERMUTATION TEST

Independence assumption is not verified !!!

H0: X and Y have the same distribution vs H1: X and Y have different distributions

```{r}
perm_t_test=function(x,y,iter=1e3){ #conditional MC -> n.iterations
  
  T0=abs(mean(x)-mean(y))  # define the test statistic
  T_stat=numeric(iter) # a vector to store the values of each iteration
  x_pooled=c(x,y) # pooled sample
  n=length(x_pooled)
  n1=length(x)
  
  for(perm in 1:iter){ # loop for conditional MC
    # permutation:
    permutation <- sample(1:n)
    x_perm <- x_pooled[permutation]
    x1_perm <- x_perm[1:n1]
    x2_perm <- x_perm[(n1+1):n]
    # test statistic:
    T_stat[perm] <- abs(mean(x1_perm) - mean(x2_perm))
    
  }
  
  # p-value
  p_val <- sum(T_stat>=T0)/iter
  return(p_val)
}


p.value <- perm_t_test(explife, predlife)
p.value

```

TWO SAMPLE PAIRED UNIVARIATE PERMUTATION TEST

H0 : E[ X - Y ] = 0 vs H1: E[ X - Y] != 0

```{r}
t1=explife
t2=predlife
p=1
n1=n
n2=n
t1.mean <- mean(t1)
t2.mean <- mean(t2)
t1.cov  <-  var(t1)
t2.cov  <-  var(t2)
Sp      <- ((n1-1)*t1.cov + (n2-1)*t2.cov)/(n1+n2-2)  # pooled cov matrix
Spinv   <- solve(Sp)

delta.0 <- 0

diff <- t1-t2
diff.mean <- mean(diff)
diff.cov <- var(diff)
diff.invcov <- solve(diff.cov)

T20 <- as.numeric(t(diff.mean-delta.0)  %*% (diff.mean-delta.0))

T2 <- numeric(B)
for(perm in 1:B)
  {
  # Random permutation
  # obs: exchanging data within couples means changing the sign of the difference
  signs.perm <- rbinom(n1, 1, 0.5)*2 - 1
  
  diff_perm <- diff * matrix(signs.perm,nrow=n1,ncol=p,byrow=FALSE)
  diff.mean_perm <- mean(diff_perm)
  diff.cov_perm <- cov(diff_perm)
  diff.invcov_perm <- solve(diff.cov_perm)
  
  T2[perm] <- as.numeric(t(diff.mean_perm-delta.0) %*% (diff.mean_perm-delta.0))
}

hist(T2,xlim=range(c(T2,T20)),breaks=100)
abline(v=T20,col=3,lwd=4)

plot(ecdf(T2))
abline(v=T20,col=3,lwd=4)

p_val <- sum(T2>=T20)/B
p_val
```

ALTERNATIVE:

Instead of performing inference on the distribution of the difference, we treat them "separately". We have 2\^N different permutations, since the **exchangeability is only within the pairs**. We choose as test statistic the norm of the differences of the means of both samples.

```{r}
T20 <- norm(as.matrix(mean(t1) - mean(t2)))

T2 <- numeric(B)
t.full <- rbind(t1, t2)
for(perm in 1:B)
  {
  # Random permutation
  # N.B. exchangeability is only within pairs
  perm.indices.t1 <- seq(1, n) + n * rbinom(n,1, 0.5)
  t1.perm <- t.full[perm.indices.t1]
  t2.perm <- t.full[-perm.indices.t1]
  
  T2[perm] <- norm(as.matrix(((mean(t1.perm)) - mean(t2.perm))))
}

hist(T2,xlim=range(c(T2,T20)),breaks=100)
abline(v=T20,col=3,lwd=4)

plot(ecdf(T2))
abline(v=T20,col=3,lwd=4)

# p-value
p_val <- sum(T2>=T20)/B
p_val
```
