
```{r}
library(readxl)
data <- read_excel("../dataset/TrainingSet.xlsx", col_names = TRUE)
```

Libraries:
```{r,'error=FALSE', 'warning=FALSE'}
library(readxl)
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
```

Summary:
```{r}
summary(data)
```
Conto numero eventi per ogni covariata
```{r}
table(data$Users, data$Status)
table(data$Purpose, data$Status)
table(data$Orbit, data$Status)
table(data$Continent, data$Status)


```
Dalla letteratura risulta che non ho abbastanza eventi per Navigation, Elliptical, Africa, Multinational, Oceania
Simulation work has suggested that at least 10 events need to be observed for each covariate considered, and anything less will lead to problems.
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2376927/

Rimuoviamo queste classi
```{r}
i <- which(data$Purpose == 'Navigation' | data$Orbit == 'Elliptical' | data$Continent == 'Africa' | data$Continent == 'Multinational' | data$Continent == 'Oceania' )
data <- data[-i,]
```

A livello di continenti è un confronto tra America, Asia e Europa: Maggiori potenze economiche 

Controlliamo
```{r}
table(data$Users, data$Status)
table(data$Purpose, data$Status)
table(data$Orbit, data$Status)
table(data$Continent, data$Status)
table(data$Status)
```


Trasformo Eccentricità per avere un miglior grafico dei residui
```{r}
i <- which(data$Eccentricity == 0)
data$Eccentricity[i] = 1
data$log.Eccentricity <- -log(data$Eccentricity)
```


```{r}
time <- data$`Effective Lifetime`
status <- data$Status

cox <- coxph(Surv(time,status == 'retired') ~  Apogee + log.Eccentricity   +
                Mass + Users + strata(Purpose) + Continent + strata(Orbit), data = data)
summary(cox)

```

## Previsione

```{r}
library(coxed)

ed1 <- coxed(cox, method="npsf")
predlife=ed1$exp.dur
#mean and median of the predicted durations:
ed1$mean
ed1$median

# PLOT: The estimated cumulative baseline hazard function and survivor function
baseline <- gather(ed1$baseline.functions, cbh, survivor, key="survivefunction", value="value")
ggplot(baseline, aes(x=time, y=value)) +
     geom_line() +
     xlab("Time") +
     ylab("Function") +
     facet_wrap( ~ survivefunction, scales = "free")
```
PREDICTION

Preparazione test set
```{r}
test.set <- read_excel("../Dataset/TestSet.xlsx", col_names = TRUE)
```


```{r}
i <- which(test.set$Purpose == 'Navigation' | test.set$Orbit == 'Elliptical' | test.set$Continent == 'Africa' | test.set$Continent == 'Multinational' | test.set$Continent == 'Oceania' )
test.set <- test.set[-i,]
```

```{r}
table(test.set$Users, test.set$Status)
table(test.set$Purpose, test.set$Status)
table(test.set$Orbit, test.set$Status)
table(test.set$Continent, test.set$Status)
table(test.set$Status)
```
Trasformo Eccentricità per avere un miglior grafico dei residui
```{r}
i <- which(test.set$Eccentricity == 0)
test.set$Eccentricity[i] = 1
test.set$log.Eccentricity <- -log(test.set$Eccentricity)
```



Per ottenere baseline hazard dei nuovi dati
```{r}
bashaz.train <- basehaz(cox)
bashaz.train
table(bashaz.train$strata) # strata su orbit e Purpose --> 8 combinazioni in teoria
```


```{r}
bashaz.test <- basehaz(cox, test.set, centered=TRUE)
bashaz.test
basehax.dataframe <- data.frame(bashaz.test)
table(bashaz.test$strata)
# technology DEvelopment, Geo non esiste  
table(test.set$Orbit, test.set$Purpose)
# technology DEvelopment, Geo non esiste neanche nel test set -> buono 

```
strata = 1 --> hazard riferita alla prima osservazione

```{r}
## S3 method for class 'coxph'
expLP = predict(cox, test.set,
#type=c("lp", "risk", "expected", "terms", "survival"),
type = 'risk',
reference=c("strata"))
```

```{r}
haz1 <- basehax.dataframe[which(basehax.dataframe$strata == 1),1]
time1 <- basehax.dataframe[which(basehax.dataframe$strata == 1),2]
```



```{r}
curva1 <- haz1 * expLP[1]
surv1 <- exp(-cumsum(curva1))

plot(time1, surv1, type ='l')

```


```{r}
for (i in 1:113) {
  haz <- basehax.dataframe[which(basehax.dataframe$strata == i), 1]
  timeS <- basehax.dataframe[which(basehax.dataframe$strata == i), 2]

  curva <- haz * expLP[i]
  surv <- exp(-cumsum(curva))

  plot(timeS, surv, type = 'l', main = paste("Survival Curve for Satellite", i),
       xlab = "Time", ylab = "Survival Probability")
}

```



```{r}
library(ggplot2)

# Creazione del dataframe
data <- data.frame(hazard = numeric(), timeS = numeric(), strata = numeric())

r <-  sample(1:113, 5, replace = FALSE)
for (i in r) {
  haz <- basehax.dataframe[which(basehax.dataframe$strata == i), 1]
  timeS <- basehax.dataframe[which(basehax.dataframe$strata == i), 2]
  strata <- rep(i, length(haz))
  data <- rbind(data, data.frame(hazard = haz, timeS = timeS, strata = strata))
}

# Calcola la curva di sopravvivenza per ogni strato
data <- transform(data, survival = exp(-cumsum(hazard * expLP[strata])))

# Creazione del grafico utilizzando ggplot2
ggplot(data, aes(x = timeS, y = survival, color = factor(strata))) +
  geom_line(size = 1.5) +
  scale_color_discrete(name = "Strata") +
  labs(x = "Time", y = "Survival Probability", title = "Survival Curves") +
  theme_minimal() +
  theme(panel.grid.major = element_line(colour = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank())

```



