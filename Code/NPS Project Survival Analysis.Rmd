---
title: "NPS Project Survival Analysis"
author: "Simone Ciardulli"
date: "`r Sys.Date()`"
output: html_document
---
Set wd:
```{r}
setwd("C:/Users/simon/OneDrive/Desktop/V Anno/I Semester/Nonparametric Statistics/Project")
```

Libraries:
```{r,'error=FALSE', 'warning=FALSE'}
library(readxl)
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
```

Import data:
```{r}
data <- read_excel("Data_Satellites.xlsx", col_names = TRUE)
```

Summary:
```{r}
summary(data)
```

Rendi colonne factor:
```{r}
data$Country <- factor(data$Country, ordered = F)
print('Country')
table(data$Country)

data$Users <- factor(data$Users, ordered = F)
print('Users')
table(data$Users)

data$Purpose <- factor(data$Purpose, ordered = F)
print('Purpose')
table(data$Purpose)

data$Orbit <- factor(data$Orbit, ordered = F)
print('Class of Orbit')
table(data$Orbit)

data$Status <- factor(data$Status, ordered = F)
print('Status')
table(data$Status)
```

Group countries by continent:
```{r}

```

Mischia righe
```{r}
data <- data[sample(nrow(data)), ]
```


Primo plot con tempi:
```{r}
data$ID <- factor(seq(1:nrow(data))) 
data_subs <- head(data)
time <- data_subs$'Effective Lifetime'

ggplot(data=data_subs,aes(x=ID,y=time)) + 
  geom_bar(stat='identity',width=0.2) +
  geom_point(aes(color=Status,shape=Status),size=6) +
  coord_flip()
```


```{r}
head(Surv(time=data$'Effective Lifetime',  # T_i
          event=data$Status == 'retired') # tell the object which rows have the event
     )
```

KM Estimator
```{r}
time <- data$'Effective Lifetime'
fit <- survfit(Surv(time,Status == 'retired') ~ 1, data = data)
```

Summary:
```{r}
summary(fit)
```

```{r}
kable(head(tidy(fit),20))
```

Median:
```{r}
surv_median(fit) #not reached
```

Rem: not reached


Plot of KM estimator curve
```{r}
ggsurvplot(fit, data = data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=5,
           title="Kaplan-Meier Curve for Satellites Survival")
```

Cumulative Failure Probability (CFP):

$$CFP(t) = P(T\leq t)$$ 
so it can be estimated as:
$$1-S(t)$$

```{r}
cumulative_incidence <- 1 - fit$surv
```

CFP plot: (ggsurvplot() function specifying the option fun=‘event’)
```{r}
ggsurvplot(fit, data = data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=5,
           fun='event',
           title="Cumulative Incidence Curve")
```

Cumulative Hazard
```{r}
ggsurvplot(fit, data = data,
           risk.table = TRUE, # Add risk table
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=5,
           fun='cumhaz',
           title="Cumulative Hazard Curve for Satellites Survival")
```


1) We construct one curve for each Continent:
```{r}
fit.Continent <- survfit(Surv(time,Status == 'retired') ~ Continent, data=data)

ggsurvplot(fit.Users, data = data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata",
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=5,
           title="Kaplan-Meier Curve for Satellites Survival by Continent")
```

Log-rank test:

```{r}
log_rank_test <- survdiff(Surv(time, Status == 'retired') ~ Continent, data=data)
log_rank_test
```

Hazard ratio:
```{r}
hazard_ratio <- (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[2]/log_rank_test$exp[2])
hazard_ratio
```



2) We construct one curve for each User:
```{r}
fit.Users <- survfit(Surv(time, Status == 'retired') ~ Users, data=data)

ggsurvplot(fit.Users, data = data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata",
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=5,
           title="Kaplan-Meier Curve for Satellites Survival by Users")
```

Log-rank test:

```{r}
log_rank_test <- survdiff(Surv(time, Status == 'retired') ~ Users, data=data)
log_rank_test # p = 0.08 
```

Hazard ratio:
```{r}
hazard_ratio_com_gov <- (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[2]/log_rank_test$exp[2])
hazard_ratio_com_gov #0.4574647 -> Commercial is a protective factor wrt Government

hazard_ratio_gov_mil <- (log_rank_test$obs[2]/log_rank_test$exp[2])/(log_rank_test$obs[3]/log_rank_test$exp[3])
hazard_ratio_gov_mil #2.414499 -> Government is a risk factor wrt Military

hazard_ratio_com_mil <- (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[3]/log_rank_test$exp[3])
hazard_ratio_com_mil #1.104548 -> Commercial is a risk factor wrt Military
```

Factors ordered by risk: Government, Commercial, Military


3) We construct one curve for each Purpose
```{r}
fit.Purpose <- survfit(Surv(time, Status == 'retired') ~ Purpose, data=data)

ggsurvplot(fit.Purpose, data = data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata",
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=5,
           title="Kaplan-Meier Curve for Satellites Survival by Purpose")
```

Log-rank test:

```{r}
log_rank_test <- survdiff(Surv(time, Status == 'retired') ~ Purpose, data=data)
log_rank_test # p= 0.01 
```

Hazard ratio:
```{r}
hazard_ratio_com_eo <- (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[2]/log_rank_test$exp[2])
hazard_ratio_com_eo #0.3114461 -> Communications is a protective factor wrt Earth Observation

hazard_ratio_nav_com <- (log_rank_test$obs[3]/log_rank_test$exp[3])/(log_rank_test$obs[1]/log_rank_test$exp[1])
hazard_ratio_nav_com #0

hazard_ratio_com_sc <- (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[4]/log_rank_test$exp[4])
hazard_ratio_com_sc #0.6003101 -> Communications is a protective factor wrt Space Science

hazard_ratio_nav_eo <- (log_rank_test$obs[3]/log_rank_test$exp[3])/(log_rank_test$obs[2]/log_rank_test$exp[2])
hazard_ratio_nav_eo #0

hazard_ratio_eo_sc <- (log_rank_test$obs[2]/log_rank_test$exp[2])/(log_rank_test$obs[4]/log_rank_test$exp[4])
hazard_ratio_eo_sc #1.927493 -> Earth Observation is a risk factor wrt Space Science

hazard_ratio_nav_sc <- (log_rank_test$obs[3]/log_rank_test$exp[3])/(log_rank_test$obs[4]/log_rank_test$exp[4])
hazard_ratio_nav_sc #0
```

Factors ordered by risk: Earth Observation, Space Science, Communications



4) We construct one curve for Orbit:
```{r}
fit.Orbit <- survfit(Surv(time,data$Status == 'retired') ~ Orbit, data=data)

ggsurvplot(fit.Orbit, data = data,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata",
           ggtheme = theme_bw(), # Change ggplot2 theme
           break.time.by=5,
           title="Kaplan-Meier Curve for Satellites Survival by Orbit")
```


Log-rank test:

```{r}
log_rank_test <- survdiff(Surv(time, Status == 'retired') ~ Orbit, data=data)
log_rank_test # p = 0.2
```

Hazard ratio:
```{r}
hazard_ratio_ell_geo <- (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[2]/log_rank_test$exp[2])
hazard_ratio_ell_geo #0.5000046 -> Earth Observation is a risk factor wrt Space Science

hazard_ratio_ell_leo <- (log_rank_test$obs[1]/log_rank_test$exp[1])/(log_rank_test$obs[3]/log_rank_test$exp[3])
hazard_ratio_ell_leo #0.8579963 -> Earth Observation is a risk factor wrt Space Science

hazard_ratio_meo_ell <- (log_rank_test$obs[4]/log_rank_test$exp[4])/(log_rank_test$obs[1]/log_rank_test$exp[1])
hazard_ratio_meo_ell #0

hazard_ratio_geo_leo <- (log_rank_test$obs[2]/log_rank_test$exp[2])/(log_rank_test$obs[3]/log_rank_test$exp[3])
hazard_ratio_geo_leo #1.715977 -> Earth Observation is a risk factor wrt Space Science

hazard_ratio_geo_meo <- (log_rank_test$obs[4]/log_rank_test$exp[4])/(log_rank_test$obs[2]/log_rank_test$exp[2])
hazard_ratio_geo_meo #0

hazard_ratio_leo_meo <- (log_rank_test$obs[4]/log_rank_test$exp[4])/(log_rank_test$obs[3]/log_rank_test$exp[3])
hazard_ratio_leo_meo #0
```


Factors ordered by risk: Earth Observation, Space Science, Communications
